<link rel="import" href="../../../bower_components/polymer/polymer-element.html" />
<link rel="import" href="../../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../../../bower_components/paper-spinner/paper-spinner.html" />
<dom-module id="lt-order-page">
	<template>
		<style include="lt-style">
			:host {
				width: 100%;
				min-height: 500px;
				display: block;
				padding: 15px 25px;
				box-sizing: border-box;
				background: #fff;
				--border-style:1px solid #ddd;
			}
			.pageContainer{
				min-height: 500px;
			}
			.header{
				color: rgba(0,0,0,0.6);
				width: 100%;
			}
			.header span:last-child{
				color :  var(--app-primary-blue);
			}
			.order_box{
				margin-top: 20px;
			}
			.num{
				color:#4e7cff;
				padding: 0;
			}
			.selector{
				display: block;
				width: 100%;
				padding-bottom: 10px;
				border-bottom: var(--border-style);
			}
			.selector .item_type{
				padding: 10px 30px;
				border-radius: 2px;
				color: #ddd;
			}
			.item_type.iron-selected:first-child{
				border-top : var(--border-style);
				border-right: var(--border-style);
				border-bottom: 1px solid #fff;
				font-weight: 800;
				color: #4a4a4a;
			}
			.item_type.iron-selected:last-child{
				border-top : var(--border-style);
				border-left: var(--border-style);
				border-bottom: 1px solid #fff;
				border-right: var(--border-style);
				font-weight: 800;
				color: #4a4a4a;
			}
			.car_table table , .product_table table{
				width: 100%;
				border-collapse:collapse;
				margin: 0 auto;
				margin-top: 20px;
			}
			td .imgBox {
				width: 25%;
			}
			table tr td{
				border : 1px solid #ddd;
				padding: 10px;
				min-width: 120px;
    			text-align: center;
    			box-sizing: border-box;
    			min-height: 110px;
			}
			table thead{
				background: #F5F5F5;
			}
			table tbody{
				background: #fff;
			}
			table tr td.detail_td{
				border-top: none;
				border-right: none;
				display: flex;
				align-items: center;
			}
			table tr td.detail_td.product{
				flex-direction: column;
			}
			.product_list{
				width: 50%;
			}
			.dec {
				margin-left: 10px;
				width: 30%;
			}
			.brand {
			    display: inline-block;
			}
			.brand::after {
			    content: " | ";
			}
			.series {
			    display: inline-block;
			}
			.model {
			    display: block;
			    color: #999999;
			    font-weight: 300;
			    margin-top: 8px;
			}
			.action{
				color: #4e7cff;
				cursor: pointer;
			}
			.cancel{
				color:#ddd;
				cursor: pointer;
			}
			.cancel:hover{
				color: #f00;
			}
			.loading{
				text-align: center;
			}	
            @media screen and (max-width:620px){
            	:host{
            		padding: 10px;
            	}
            	.name{
            		font-size: 14px;
            		margin: 0;
            	}
            	table tr td.detail_td{
            		flex-direction: column;
            	}
            	td .imgBox ,td .dec{
            		width: 100%;
            		margin: 0;
            	}

            }
		</style>
		<div class="pageContainer">
			<div class="header">
				当前位置：<span>首页</span> > <span>我的订单</span>
			</div>
			<div class="order_box">
				<iron-selector selected="{{selectType}}" class="selector" attr-for-selected="id" fallback-selection="car">
					<span class="item_type" id="car">车辆 <span class="num">({{orderCarList.length}})</span></span>
					<span class="item_type" id="product">商品 <span class="num">({{productList.length}})</span></span>
				</iron-selector>
				<div class="loading" hidden="{{!loading}}">
					<paper-spinner active="{{loading}}"></paper-spinner>
				</div>
				<div class="car_table" id="car_table">
					<table>
						<thead>
							<tr>
								<td>订单名称</td>
								<td>状态</td>
								<td>操作</td>
							</tr>
						</thead>
						<tbody>
							<template is="dom-repeat" items="{{orderCarList}}">
								<tr>
									<td class="detail_td">
										<div class="imgBox" style="background: url(../../../images/default_bg.jpg);">
											<img src$="{{item.defaultImgUrl}}" width="100%">
										</div>
										<div class="dec">
											<span class="brand">{{item.vehicleBrandName}}</span>
											<span class="series">{{item.vehicleSeriesName}}</span>
											<span class="model">{{item.vehicleModelName}}</span>
										</div>	
									</td>
									<td>
										<template is="dom-if" if="{{_checkStatus(item.status,1)}}" restamp>
											<img src="../../../images/order_car/confirm.png" width="30px" height="30px">
											<div>已选店</div>
										</template>
										<template is="dom-if" if="{{_checkStatus(item.status,2)}}" restamp>
											<img src="../../../images/order_car/confirm_no.png" width="30px" height="30px">
											<div>待确认</div>
										</template>
										<template is="dom-if" if="{{_checkStatus(item.status,3)}}" restamp>
											<img src="../../../images/order_car/confirm_store.png" width="30px" height="30px">
											<div>待选店</div>
										</template>
									</td>
									<td>
										<template is="dom-if" if="{{_checkStatus(item.status,3)}}" restamp>
											<div class="action" on-click="_chooseShop">选店</div>
										</template>
										<template is="dom-if" if="{{_checkStatus(item.status,1)}}" restamp>
											<div class="action" on-click="_getCarOrderDetail">查看订单</div>
										</template>
										<div class="cancel">取消订单</div>
									</td>
								</tr>
							</template>
						</tbody>
					</table>
				</div>
				<div class="product_table" id="product_table">
					<table>
						<thead>
							<tr>
								<td>订单名称</td>
								<td>产品列表</td>
								<td>操作</td>
							</tr>
						</thead>
						<tbody>
							<template is="dom-repeat" items="{{productList}}">
								<tr>
									<td class="detail_td product">
										<div class="imgBox">
											<img src$="{{item.productDetails.0.defaultImgUrl}}" width="100%">
										</div>
										<div class="dec">
											{{item.productDetails.0.name}}
										</div>	
									</td>
									<td class="product_list">
										<template is="dom-repeat" items="{{item.productDetails}}" as="product">
											<div class="productItem">
												{{product.name}} <span class="num">({{product.num}})</span>
											</div>
										</template>
									</td>
									<td>
										<div class="action" on-click="_getProductOrderDetail">订单详情</div>
										<div class="cancel">取消订单</div>
									</td>
								</tr>
							</template>
						</tbody>
					</table>
				</div>
			</div>
		</div>
		<!-- 获取订单列表 -->
		<iron-ajax
		    id="getOrderList"
		    method="POST"
		    headers='{{header}}'
		    body = "{}"
		    loading="{{loading}}"
		    url="{{_calUserUrl('order/shopping/getPurchaseOrderList')}}"
		    Content-Type="application/json"
		    handle-as="json"
		    on-response="_responseOrderList">
		</iron-ajax>
	</template>
	<script>
		class ltOrderPage extends ltMixin(Polymer.Element){
			static get is(){return "lt-order-page"}
			static get properties(){
				return {
					selectType : {
						type : String,
						observer : "_checkType"
					}
				}
			}
			static get observers (){
				return [

				]
			}
			// 选店
			_chooseShop (e){
				var detail = e.model.__data.item;
				// 将需要选店的车数据放入缓存
				localStorage.setItem('shop_car_detail',JSON.stringify(detail));
				location.hash = "#/choose-shop";
			}
			// 产品
			_getProductOrderDetail(e){
				var detail = e.model.__data.item;
				var obj = {};
				// 将订单数据放入缓存;
				obj.type = "product";
				obj.detail = detail;
				localStorage.setItem('order_detail',JSON.stringify(obj));
				location.hash = "#/order-detail";
			}
			// 车订单详情
			_getCarOrderDetail(e){
				var detail = e.model.__data.item;
				var obj = {};
				// 将订单数据放入缓存;
				obj.type = "vehicle";
				obj.detail = detail;
				localStorage.setItem('order_detail',JSON.stringify(obj));
				location.hash = "#/order-detail";
			}
			// 检查订单状态
			_checkStatus(status , val){
				if(status == val){
					return true
				}else{
					return false
				}
			}
			// 订单
			_responseOrderList(e){
				this.orderCarList = e.detail.response.vehicleOrderDatas || [];
				// 处理车的状态
				this.orderCarList.forEach((item)=>{
					if(item.status == "MEMBER_SELECT_SHOP"){
						item.status = "1"; // 已选店
					}else if(item.status == "SUPPLER_NOT_CONFIRM"){
						item.status = "2"; // 待确认
					}else{
						item.status = "3"; // 待选店
					}
				})
				this.productList = e.detail.response.datas || [];
			}
			// 显示的table
			_checkType (val){
				this.$.car_table.hidden = true;
				this.$.product_table.hidden = true;
				if(val == "car"){
					this.$.car_table.hidden = false;
				}else{
					this.$.product_table.hidden = false;
				}
			}
			show(){
             	this.style.display= 'block';
             	// get cart req,if login
             	if(header['X-CustomToken']){
             		this.$.getOrderList.body = {
             			userName : header["X-USERNAME"]
             		}
             		this.$.getOrderList.generateRequest();
             	}else{
             		this.dispatchEvent(new CustomEvent('confirm', {detail:{msg:"请先登录!"} ,bubbles: true, composed: true}));
             		setTimeout(function(){
             			location.hash = "#/home"
             		},2000)
             	}
            }
            hide(){
             	this.dispatchEvent(new CustomEvent('hide',{}),false);
				this.style.display= 'none';
            }

		}
		customElements.define(ltOrderPage.is,ltOrderPage)
	</script>
</dom-module>
